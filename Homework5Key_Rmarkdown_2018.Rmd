---
title: "N736 Homework 5 - Answer Key in R Markdown"
author: "Melinda K. Higgins, PhD."
date: "December 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# load packages needed
library(knitr)
library(HH)
library(tidyverse)
library(haven)
library(olsrr)
library(effects)
library(car)
library(sjPlot)

# load HELP dataset
help1 <- haven::read_spss("helpmkh.sav")
```

## Homework 05 - due 11/14/2018

### Analysis of Covariance and Moderation Exercise

For Homework 05, you will be using the HELP dataset, learn more at:

* [https://melindahiggins2000.github.io/N736Fall2017_HELPdataset/](https://melindahiggins2000.github.io/N736Fall2017_HELPdataset/) &
* [https://github.com/melindahiggins2000/N736Fall2017_HELPdataset](https://github.com/melindahiggins2000/N736Fall2017_HELPdataset)

Complete the following for these variables:

* OUTCOME VARIABLE (Y): `mcs`
* INDEPENDENT VARIABLE (X): `age`
* COVARIATES (other X's): `homeless`

### Variables in HELP dataset to be used for Homework 05

```{r, echo=FALSE, message=FALSE, warning=FALSE}
helpdata <- readRDS("helpmkh.rds")
library(tidyverse)
sub1 <- helpdata %>%
  select(mcs,age,homeless)

# create a function to get the label
# label output from the attributes() function
getlabel <- function(x) attributes(x)$label
# getlabel(sub1$age)

library(purrr)
ldf <- purrr::map_df(sub1, getlabel) # this is a 1x15 tibble data.frame
# t(ldf) # transpose for easier reading to a 15x1 single column list

# using knitr to get a table of these
# variable names for Rmarkdown
library(knitr)
knitr::kable(t(ldf),
             col.names = c("Variable Label"),
             caption="Use these variables from HELP dataset for Homework 05")

```

### ANSWER KEY - MODEL 1 (`homeless` single predictor)

1. [MODEL 1] Run a model testing to see if there is a difference in mental health `mcs` scores by homelessness (`homeless`) _(run as a regression model with `mcs` as the outcome)_ 
    * Discuss the interpretation of the intercept _(i.e. when `homeless` = 0)_ and 
    * discuss the interpretation of the slope _(i.e. what happens to `mcs` scores when going from not homeless (`homeless`=0) to homeless (`homeless`=1))_.
    
#### Add Recoded Variables to `help2`
    
```{r}
# create flipped coding to check
# significant interaction effects depending
# on contrasts tested by coefficient/terms in model
help2 <- help1 %>%
  select(mcs, age, homeless) %>%
  mutate(nothomeless = as.numeric((homeless==0)),
         age_x_homeless = age * homeless,
         age_x_nothomeless = age * nothomeless)
```

#### Results using `lm()`

```{r}
m1 <- lm(mcs ~ homeless, data=help2)
summary(m1)
```

#### better formatting of regression results using `knitr`

```{r}
# extract coefficients table from model summary
# print as a table using knitr::kable()
knitr::kable(summary(m1)[["coefficients"]])
```

The intercept (when `homeless`=0) reflects the average `mcs` score when subjects were NOT homeless which was `r coef(m1)[1]`. This intercept was significantly different from 0, p-value = `r formatC(summary(m1)[["coefficients"]][7], format="e", digits=3)`.

For this model, the slope reflects the change in `mcs` scores for a 1 unit change in `homeless` - basically the difference in `mcs` scores in going from `homeless`=0 to `homeless`=1. This difference in `mcs` (i.e. the slope term) is `r coef(m1)[2]`. This slope was not significantly different from 0, p-value = `r formatC(summary(m1)[["coefficients"]][8], format="e", digits=3)`. _NOTE: This is the same a running a t-test to compare the `mcs` score differences between subjects who were and were not homeless._

#### Results using optional `olsrr` package

The `olsrr` package provides more detailed results for `lm()` model results. This is optional.

```{r}
# optional use of the olsrr package
# to get nicer output

library(olsrr)
olsrr::ols_regress(m1)
```

### ANSWER KEY - MODEL 2 (`homeless` and `age` as predictors)
    
2. [MODEL 2] Run a model testing for an association between `mcs` as the outcome with `age` as the predictor adjusting for homelessness (`homeless`) as a "covariate". 
    * Use a regression approach and show the stepwise approach comparing 
        - model 1: mcs = homeless
        - model 2: mcs = homeless + age
    * present the change in R2 between these 2 models and the test for significant change in R2
    * discuss these results - is there a significant association between `mcs` and `age` after adjusting for `homeless`?
    
#### Results using `lm()`

```{r}
m2 <- lm(mcs ~ homeless + age, data=help2)
summary(m2)
```

#### better formatting of regression results using `knitr`

```{r}
# extract coefficients table from model summary
# print as a table using knitr::kable()
knitr::kable(summary(m2)[["coefficients"]])
```

#### Results using optional `olsrr` package

The `olsrr` package provides more detailed results for `lm()` model results. This is optional.

```{r}
# optional use of the olsrr package
# to get nicer output
olsrr::ols_regress(m2)
```

#### Compute changes in R2 from model 1 to model 2

```{r}
# to get p-values of r2 change
# works for "nested" models
anova(m1,m2)
pv1 <- anova(m1,m2)$`Pr(>F)`[2]

# r2 change
summary(m1)$r.squared - summary(m2)$r.squared
```

Adding `age` to the model increases R2 by `r summary(m1)$r.squared - summary(m2)$r.squared` which was not statistically significant, p-value = `r pv1`.

So, after adjusting for `homeless`, there is no significant association between `age` and `mcs`.
    
### ANSWER KEY - MODEL 3 (`homeless` and `age` interaction effect)
    
3. [MODEL 3] Run a full model with both main effects and an interaction (moderation) effect _(using a regression, ANOVA, or GLM approach - your choice)_ for the association between the SF36 Mental Component Score (`mcs`) and Age (`age`) adjusting for homelessness (`homeless`). Remember to:
    * check for the assumption of homogenity of slopes _(i.e. is the interaction term significant?)_
    * make an "effects plot" plot of the interaction between `age` and `homeless` 
    * and additionally report the change in R2 for
        - model 3: mcs = homless + age + homeless_x_age
    * discuss the results - does homelessness moderate the association between `mcs` and `age`?
    
#### Results using `lm()`

```{r}
# use the * operator to add the interaction term
m3 <- lm(mcs ~ homeless * age, data=help2)
summary(m3)
```

#### better formatting of regression results using `knitr`

```{r}
# extract coefficients table from model summary
# print as a table using knitr::kable()
knitr::kable(summary(m3)[["coefficients"]])
```

#### Results using optional `olsrr` package

The `olsrr` package provides more detailed results for `lm()` model results. This is optional.

```{r}
# optional use of the olsrr package
# to get nicer output
olsrr::ols_regress(m3)
```

#### Compute changes in R2 from model 2 to model 3

The change in R2 from model 2 `m2` to model 3 `m3` tests the addition of the interaction term `homeless * age`.

```{r}
# to get p-values of r2 change
# works for "nested" models
anova(m2,m3)
pv2 <- anova(m2,m3)$`Pr(>F)`[2]

# r2 change
summary(m2)$r.squared - summary(m3)$r.squared
```

Adding the `homeless * age` interaction term to the model increases R2 by `r summary(m2)$r.squared - summary(m3)$r.squared` which was is statistically significant, p-value = `r pv2`.

So, there is a significant interaction effect between `age` and `homeless` for predicting `mcs`. Thus, the homogenity of slopes assumption is not met - the interaction effect is significant and should be included in the model.

Interpretation - for homeless subjects, older subjects had higher mental health scores, whereas older non-homeless subjects had lower mental health scores. The association between `age` and `mcs` is positive for homeless subjects and negative for non-homeless subjects.

#### p-value for `age` changes for flipped coding for `homeless`

Remember to check the p-values again for the flipped coding for `homeless`, i.e. rerun the models using `nothomeless` we coded above.

The results below show that the effect of age was significant when `nothomeless`=0, i.e. the slope of the line between `age` and `mcs` is significant for homeless subjects. Conversely, as we saw above the slope of the line between `age` and `mcs` for non-homeless subjects was not significant (when `homeless`=0).

#### Results using `lm()`

```{r}
# use the * operator to add the interaction term
m3flip <- lm(mcs ~ nothomeless * age, data=help2)
summary(m3flip)
```

#### better formatting of regression results using `knitr`

```{r}
# extract coefficients table from model summary
# print as a table using knitr::kable()
knitr::kable(summary(m3flip)[["coefficients"]])
```

#### Results using optional `olsrr` package

The `olsrr` package provides more detailed results for `lm()` model results. This is optional.

```{r}
# optional use of the olsrr package
# to get nicer output
olsrr::ols_regress(m3flip)
```

#### Here is a plot of this interaction effect.

```{r}
#' create "factor" class type for homeless
#' this is so the effects package
#' function will work correctly
help2$homeless.f <- factor(help2$homeless,
                           levels = c(0,1),
                           labels = c("not homeless",
                                      "homeless"))

# for the effects package plots to work
# we also need to put homeless.f first and then age
m3f <- lm(mcs ~ age * homeless.f, data=help2)
summary(m3f)

# use effects package to get interaction plot
plot(allEffects(m3f))
```

#### Other plot using `sjplot` package

L earn more at [http://www.strengejacke.de/sjPlot/reference/plot_model.html](http://www.strengejacke.de/sjPlot/reference/plot_model.html)

```{r}
# put homeless as second term to get
# interaction plot with lines by homelessness
# use m3f model as above
plot_model(m3f, type="int",
           show.ci=TRUE,
           facet.grid=TRUE)
```

