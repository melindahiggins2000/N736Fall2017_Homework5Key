---
title: "N736 Homework 5 - Answer Key in R Markdown"
author: "Melinda K. Higgins, PhD."
date: "November 13, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# load packages needed
library(tidyverse)
library(haven)
library(olsrr)
library(effects)
library(car)
library(HH)
library(sjPlot)

# load HELP dataset
help1 <- haven::read_spss("helpmkh.sav")
```

## Create Data subset and recode variables

The R code chunk below selects the variables we want for 
this lesson: 

* DV: `indtot`
* IV: `mcs`
* CV: `pss_fr` or `female`

The code also recodes `female` to `male` by flipping the 0,1 and let's mean center `mcs` and `pss_fr` since we'll also look at the interaction between these variables plus the interactions between `mcs` and gender (e.g. `female` or `male`).

```{r}
help2 <- help1 %>%
  dplyr::select(indtot, mcs, pss_fr, female) %>%
  dplyr::mutate(mcsC = mcs - mean(mcs),
         pss_frC = pss_fr - mean(pss_fr),
         male = as.numeric((female==0)),
         mcsC_x_pss_frC = mcsC * pss_frC,
         mcsC_x_female = mcsC * female,
         mcsC_x_male = mcsC * male)
```

## Run regression with interaction terms

Using a regression approach - look at `pss_fr` as a covariate for the relationship between `indtot` and `mcs` note the use of `*` which computes the interaction for you.

```{r}
# use lm for the regression model
m1 <- lm(indtot ~ mcsC * pss_frC, data=help2)

# simple summary of the model results
summary(m1)

# more verbose summary of results using olsrr package
# this looks more like SPSS or SAS type output
olsrr::ols_regress(m1)
```

Using the `aov` function - analysis of variance approach

```{r}
m1aov <- aov(indtot ~ mcsC * pss_frC, data=help2)
summary(m1aov)
olsrr::ols_regress(m1aov)
```

## Effect Plot

Also make the effectplot showing the interaction or lack thereof between `mcs` and `pss_fr` for `indtot`.

```{r}
plot(effects::effect("mcsC:pss_frC", m1, 
            xlevels=list()),
     multiline=TRUE, ylab="INDTOT", rug=FALSE)
```

## Look at gender as a covariate

Now let's look at gender as a covariate first run for `female` then run for `male` - compare the coding effect on the resulting model coefficients.

```{r}
m2f <- lm(indtot ~ mcsC * female, data=help2)
summary(m2f)
olsrr::ols_regress(m2f)

m2m <- lm(indtot ~ mcsC * male, data=help2)
summary(m2m)
olsrr::ols_regress(m2m)
```

## Run using `aov`

We can also run these models using the `aov` function and then the `Anova` function from the `car` package can be used to get the Type III Sums of Squares.

```{r}
m2f.aov <- aov(indtot ~ mcsC * female, data=help2)
summary(m2f.aov)
olsrr::ols_regress(m2f.aov)

# check type III SS using Anova() from car package
car::Anova(m2f.aov, type=3)

# run again for male
m2m.aov <- aov(indtot ~ mcsC * male, data=help2)
car::Anova(m2m.aov, type=3)
```

## Effects plot

Let's also make the effectplot showing the interaction or lack thereof between `mcs` and `female` for `indtot`.

```{r}
# For this we use the model created above
# m2f
# summary(m2f)

plot(effects::effect("mcsC*female", m2f, 
            xlevels=list(female=0:1)),
     multiline=TRUE, ylab="INDTOT", rug=FALSE)
```

## Alternative ANCOVA approach using the `HH` package

```{r}
# note: to use the ancova() function in the HH
# package, the categorical variable female
# must be of factor class.
class(help2$female)
help2$femaleF <- as.factor(help2$female)
class(help2$femaleF)

hhaov <- HH::ancova(indtot ~ mcsC * femaleF, data=help2)
```

See summary and associated effect plot from the `HH` package.

```{r}
hhaov
```

## Plots using the `ggplot2` package

The interaction plots can also be done using `qplot()` function from the `ggplot2` package and we can overlay a smooth regression fit line. NOTE: `ggplot2` should already be loaded when we loaded the `tidyverse` package above.

```{r}
ggplot2::qplot(x=mcsC, y=indtot, facets=~female, data=help2) +
  geom_smooth(method="lm")
```

## Can also use the `sjPlot` package

YOu can learn more about the `sjPlot` package at [http://www.strengejacke.de/sjPlot/sjp.int/](http://www.strengejacke.de/sjPlot/sjp.int/).

```{r}
m3f <- lm(indtot ~ female * mcsC, data=help2)

sjp.int(m3f, type="eff",
        show.ci=TRUE,
        facet.grid=TRUE)
```

